# v1 リリースロードマップ

## 概要

Phase 1〜4 の全 99 コマンド + `issue delete` の実装が完了し、CI/CD・ドキュメント・テストも整備済み。
本ドキュメントでは v1.0.0 リリースに向けて必要なタスクと推奨タスクを整理する。

---

## 1. リリースブロッカー（必須）

### 1.1 `engines` フィールドの追加

**対象**: `packages/cli/package.json`

現在 `engines` フィールドが未設定。ユーザーが非対応の Node.js バージョンで実行した際に、分かりにくいエラーが発生する可能性がある。

```json
{
  "engines": {
    "node": ">=18"
  }
}
```

- `bin/backlog.mjs` が ESM（`import` 構文）を使用しているため、Node.js 18 以上が必要
- Bun ランタイムでの実行も考慮し、`bun` エンジンの指定も検討

### 1.2 npm publish の E2E 検証

リリースパイプラインが実際に動作するか、一度 dry-run で確認する。

- [ ] `npm pack --dry-run` でパッケージ内容を確認（不要ファイルが含まれていないか）
- [ ] `npm publish --dry-run` でパブリッシュ可能か確認
- [ ] パッケージインストール後の動作確認: `npm install -g` → `backlog --help` → `backlog --version`
- [ ] `bin/backlog.mjs` → `dist/backlog.mjs` の参照パスが正しいか
- [ ] release.yaml の `npm pkg delete` ステップで依存が消えてもバンドル済みバイナリが動くか

### 1.3 テストカバレッジの補完

テスト未作成のユーティリティが 2 件残っている。

| ファイル | 内容 | 優先度 |
|---|---|---|
| `src/utils/argv.ts` | `extractSpaceArg` — `--space` フラグの事前抽出 | 高（ロジックがあり、エッジケースがある） |
| `src/utils/oauth-callback.ts` | OAuth コールバックサーバー | 中（HTTP サーバーのテストは複雑だが、認証の要） |

`argv.ts` は純粋関数なのでテストが書きやすく、優先的に対応すべき。

### 1.4 初回リリースバージョン戦略の決定

release-please のマニフェストが `0.0.0` のため、初回リリースでどのバージョンにするか決める必要がある。

**選択肢:**

- **A) `1.0.0` から開始**: `.release-please-manifest.json` を `"1.0.0"` に書き換えてからマージ。release-please が v1.0.0 のリリース PR を作成する
- **B) `0.1.0` → `1.0.0`**: まず 0.x でプレリリースし、フィードバックを経て 1.0.0 に上げる

推奨: 機能が十分に揃っているため **A** で問題ない。ただし v1 以降は破壊的変更がメジャーバージョンアップを要求するため、CLI のインターフェース（引数名・オプション名・出力形式）を v1 リリース前に最終確認すること。

---

## 2. 強く推奨（v1 の品質を上げるもの）

### 2.1 CLI インターフェースの最終レビュー

v1 以降は Semantic Versioning により、CLI のインターフェース変更が破壊的変更となる。リリース前に以下を確認：

- [ ] 全コマンドのフラグ名の一貫性（例: `--project` / `-p` が統一されているか）
- [ ] `--json` 出力のフィールド名が API レスポンスと一致しているか
- [ ] エラーメッセージの文言が統一されているか（日本語 / 英語の混在がないか）
- [ ] `--help` テキストの品質（description が分かりやすいか、examples があるか）
- [ ] exit code の一貫性（成功=0、認証エラー=1、引数エラー=1 等）

### 2.2 Node.js バージョンマトリクスでの CI テスト

現在 CI は Node.js 22 のみでテスト。ユーザー環境を考慮して複数バージョンで検証すべき。

```yaml
strategy:
  matrix:
    node-version: [18, 20, 22]
```

最低でも Node.js 18（LTS）と 22（Current LTS）でのテストを追加。

### 2.3 `process.exit()` の呼び出し箇所の監査

現在 27 ファイル・48 箇所で `process.exit()` を呼んでいる。CLI ツールとして exit は正常だが、以下を確認：

- exit code が適切か（認証エラー、バリデーションエラー等で区別するか）
- 不要な exit がないか（citty の `runMain` が自動的にハンドリングする箇所）

### 2.4 セキュリティレビュー

- [ ] OAuth の state パラメータが十分なエントロピーを持っているか
- [ ] `~/.backlogrc` のファイルパーミッションが適切か（600 等）
- [ ] API キーがログ出力に含まれないか（`consola.debug` 等）
- [ ] 依存パッケージの脆弱性チェック（`bun audit` / `npm audit`）

---

## 3. 推奨（あると良いもの）

### 3.1 CHANGELOG.md の初期生成

release-please が自動生成するが、v1.0.0 リリース時点での CHANGELOG.md がリポジトリに含まれていると、GitHub 以外（npm のページ等）でも変更履歴が参照しやすい。

### 3.2 起動パフォーマンスの計測

CLI は起動速度が UX に直結する。v1 リリース前にベースラインを計測しておくと、今後のリグレッション検知に役立つ。

```bash
hyperfine 'backlog --help' --warmup 3
```

サブコマンドの遅延読み込み（lazy import）は実装済みだが、依存ツリーが大きくなっていないか確認。

### 3.3 エラーメッセージの改善

- 認証未設定時のメッセージに `backlog auth login` コマンドの案内があるか
- ネットワークエラー時にリトライの案内があるか
- 存在しないサブコマンドを入力した際の typo サジェスション（citty が対応していれば）

### 3.4 シェル補完の動作検証

`backlog completion` コマンドが生成するスクリプトを、主要シェルで実際に動作確認：

- [ ] bash
- [ ] zsh
- [ ] fish（対応している場合）

### 3.5 ドキュメントサイトの最終確認

- [ ] 全コマンドページが正しくレンダリングされるか
- [ ] OpenAPI リファレンスが最新か
- [ ] インストールガイドが `@simochee/backlog-cli` の正しいパッケージ名を参照しているか
- [ ] リンク切れチェック

### 3.6 `--no-input` フラグの全コマンド対応確認

CI/CD 環境で使われることを想定し、インタラクティブプロンプトが表示される全コマンドで `--no-input` が正しく動作するか確認。

---

## 4. v1 以降に検討（スコープ外）

以下は v1 リリースには含めないが、v1.x で検討する項目：

| 項目 | 概要 |
|---|---|
| `issue attachments` / `pr attachments` | ファイルアップロード/ダウンロード対応 |
| プラグインシステム | サードパーティ拡張の仕組み |
| 設定ファイルのマイグレーション | `~/.backlogrc` のスキーマ変更時の自動マイグレーション |
| `backlog update` | セルフアップデートコマンド |
| Keyring 連携 | OS のキーチェーンに認証情報を保存 |
| オフラインキャッシュ | プロジェクト一覧等のキャッシュでオフライン操作対応 |

---

## リリース手順（案）

1. 上記のリリースブロッカーを全て解消
2. `main` ブランチで最終確認（CI green、テスト全通過）
3. `.release-please-manifest.json` を `"1.0.0"` に更新してコミット
4. release-please が v1.0.0 の Release PR を自動作成
5. Release PR をマージ → GitHub Release 作成 → npm 自動パブリッシュ
6. `npm install -g @simochee/backlog-cli` で動作確認
7. ドキュメントサイトの更新を確認
8. SNS やブログでアナウンス
