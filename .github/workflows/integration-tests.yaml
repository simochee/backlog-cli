name: Integration Tests

on:
  workflow_dispatch:
  schedule:
    # 毎週月曜 09:00 JST (日曜 24:00 UTC)
    - cron: "0 0 * * 1"

concurrency:
  group: integration-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    environment: integration-tests
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Run integration tests
        env:
          BACKLOG_SPACE: ${{ secrets.BACKLOG_SPACE }}
          BACKLOG_API_KEY: ${{ secrets.BACKLOG_API_KEY }}
          BACKLOG_PROJECT: ${{ secrets.BACKLOG_PROJECT }}
          BACKLOG_REPO: ${{ secrets.BACKLOG_REPO }}
          BACKLOG_PR_BASE_BRANCH: ${{ secrets.BACKLOG_PR_BASE_BRANCH }}
          BACKLOG_PR_SOURCE_BRANCH: ${{ secrets.BACKLOG_PR_SOURCE_BRANCH }}
        run: bun run test:integration
